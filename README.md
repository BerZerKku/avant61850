# 1. AVANT61850 

Файлы загрузчика, ядро, конфигурации ОС и т.д. для AVANT 61850.

- [1. AVANT61850](#1-avant61850)
	- [1.1. Версии плат](#11-версии-плат)
	- [1.2. Порядок работы](#12-порядок-работы)
	- [1.3. Возможные ошибки](#13-возможные-ошибки)
	- [1.4. TODO](#14-todo)

## 1.1. Версии плат

- BVP_61850_V2.4
- IMR_61850_V1.1

## 1.2. Порядок работы

- Собрать *linux kernel*
	```sh
	linux-raspbian-3.18.11/build.sh
	```
	- Собрать драйвера
		```sh
		xr7-drivers/build.sh
		```
- Собрать дерево устройство
	```sh
	device-tree/make
	```

> Результаты работы скриптов находятся в папках *!build*.


## 1.3. Возможные ошибки

- make: dtc: Command not found
	```sh
	sudo apt install device-tree-compiler
	```

- fatal error: curses.h: No such file or directory
	```sh
	sudo apt install libncurses5-dev libncursesw5-dev
	```


## 1.4. TODO

- [ ] Разобраться с настройками *VLAN*  
	Три модуля могут работать как с *оригинальными* настройками из образа *XRS*, так и при полном их отсутствии.
- [ ] Узнать почему растет время загрузки при добавлении второго *VLAN*  
	Похоже время уходит на запись в тысячи регистров *VLAN*.   
	Без дополнительных настроек *VLAN* время загрузки с ростом количества модулей практически не меняется.
- [ ] Добавить в скрипты *build.sh* зависисмости *make/install/clean*
- [ ] Избавиться от *NOHZ: local_softirq_pending 08* при загрузке
- [ ] Разобраться почему с деревом на три модуля, без *xf3* грузится ОС, а стоит убрать *xf2* - виснет.

!image:
- [ ] Синхронизировать настройки *fcmd* в папках *etc* и *var*
- [ ] В рабочую версию образа в *cmdline.txt* добавить *loglevel=4 (KERN_WARNING)* или *3 (KERN_ERR)*

linux-raspbian-3.18.11:
- [x] Сделать драйвер *PL011* в виде модуля.

xr7-drivers:
- [ ] Исправить работу драйвера *tty\** после потери связи  
	При тестировании *ttyUart* при помощи *loop_delay* происходит потеря большого количества связи после обрыва/восстановления физической связи приемника и передатчика.
	Исправлено зависание ОС при маниупуляции с *ethernet* интерфейсами при запущенном сервере *iec618508
- [x] Исправить алгоритм определения модели *Raspberry* в драйвере *uart*
- [x] Добавить выбор подключения к БСП или БВП параметром модуля *tty\**  
	Для модулей *tty\** добавлен параметр *connect* со значениями *BVP* и *BSP*
- [ ] Разобраться с используемыми командами в драйвере *tty\** *ioctl*
- [ ] Добавить в драйвера *tty\** настройку параметров termios
- [ ] Проверить *IRQ mini Uart* на *Raspberry 3, 3+, 4* и разных ядрах. При необходимости учесть в *ttyUart1*
- [x] Добавить в драйвера *ttyUart1* прием и передачу с использованием *FIFO*  
- [x] Добавить в драйвера *tty\** *iounmap* в случае ошибки при регистрации
- [ ] Вынести одинаковую часть драйверов *tty\** в отдельный файл
- [ ] Исправить выгрузку *tty\** модулей через скрипт *prosoft*
	По команде *sudo service prosoft stop* драйвер ttyUart? модуль завершет работу но не выгружается.
	Пока проеблема решена путем добавления *sleep 1* перед завершением кажого из модулей *tty\**

device-tree:
- [ ] Сделать сборку трех вариантов деревьев
- [ ] Сделать возможность выбора модулей через *overlay*
- [ ] Сделать возможность выбора *rtc* через *overlay*
	При этом учесть конфигурацию fcmd.	